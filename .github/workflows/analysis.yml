name: Performance Analysis

on:
  workflow_dispatch:
    inputs:
      domain:
        description: "TACo domain (devnet or mainnet)"
        required: true
        default: devnet
        type: choice
        options:
          - devnet
          - mainnet
      cohort_id:
        description: "Cohort ID"
        required: true
        default: "1"
        type: string
      chain_id:
        description: "Chain ID (84532=Base Sepolia, 8453=Base)"
        required: true
        default: "84532"
        type: string
      mode:
        description: "Test mode"
        required: true
        default: steady
        type: choice
        options:
          - steady
          - sweep
      rate:
        description: "Request rate (req/s)"
        required: true
        default: "2"
        type: string
      duration:
        description: "Duration per rate (seconds)"
        required: true
        default: "60"
        type: string

env:
  INFURA_API_KEY: ${{ secrets.INFURA_API_KEY }}
  PIMLICO_API_KEY: ${{ secrets.PIMLICO_API_KEY }}

jobs:
  analysis:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - run: npm ci

      - name: Run Analysis
        run: |
          npx tsx src/runner.ts \
            --config=configs/analysis.yml \
            --domain=${{ inputs.domain }} \
            --cohort=${{ inputs.cohort_id }} \
            --chain=${{ inputs.chain_id }} \
            --mode=${{ inputs.mode }} \
            --rate=${{ inputs.rate }} \
            --duration=${{ inputs.duration }} \
            --verbose

      - name: Generate Report
        run: npx tsx src/report.ts --latest

      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: taco-perf-analysis-${{ github.run_number }}
          path: results/
          retention-days: 90

      - name: Prepare Pages
        run: |
          mkdir -p _site/reports
          cp results/reports/*.html _site/reports/ 2>/dev/null || true
          git fetch origin gh-pages:gh-pages 2>/dev/null || true
          if git show gh-pages:reports/ 2>/dev/null; then
            for f in $(git ls-tree --name-only gh-pages:reports/); do
              if [ ! -f "_site/reports/$f" ]; then
                git show "gh-pages:reports/$f" > "_site/reports/$f" 2>/dev/null || true
              fi
            done
          fi
          LATEST=$(ls -t _site/reports/*.html 2>/dev/null | head -1 | xargs basename 2>/dev/null)
          if [ -n "$LATEST" ]; then
            printf '<meta http-equiv="refresh" content="0; url=reports/%s">' "$LATEST" > _site/index.html
          fi
          echo '<html><head><title>TACo Performance Reports</title>' > _site/reports/index.html
          echo '<style>body{font-family:monospace;background:#1a1a2e;color:#e0e0e0;padding:2em}a{color:#96FF5E}h1{color:#fff}</style>' >> _site/reports/index.html
          echo '</head><body><h1>TACo Performance Reports</h1><ul>' >> _site/reports/index.html
          for f in $(ls -t _site/reports/*.html | grep -v index.html | xargs -I{} basename {}); do
            echo "<li><a href=\"$f\">$f</a></li>" >> _site/reports/index.html
          done
          echo '</ul></body></html>' >> _site/reports/index.html
          touch _site/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          keep_files: false
